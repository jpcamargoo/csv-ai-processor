<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV + IA Processor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50">
    <!-- Banner de confirma√ß√£o -->
    <div style="background: linear-gradient(90deg, #ff4444, #44ff44); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px;">
        ÔøΩ DEPLOY v2.1 ATIVO - EDITADO DIRETAMENTE PELO COPILOT ÔøΩ
    </div>

    <div class="max-w-4xl mx-auto p-6" x-data="csvProcessor()">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">CSV + IA Processor</h1>
            <p class="text-gray-600 mt-2">Processe seus arquivos CSV com Intelig√™ncia Artificial</p>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Upload do CSV</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <input type="file" @change="handleFileUpload" accept=".csv" class="hidden" id="csvFile">
                <label for="csvFile" class="cursor-pointer">
                    <p class="text-lg mb-2">Clique para selecionar seu arquivo CSV</p>
                </label>
            </div>
            <div x-show="fileName" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-green-800">üìÑ Arquivo: <span x-text="fileName"></span></p>
            </div>
        </div>

        <!-- Processing Options -->
        <div x-show="csvContent" class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">Tipo de Processamento:</h3>
            <select x-model="operation" class="w-full p-3 border border-gray-300 rounded-lg">
                <option value="expand">üìä Expandir (mais detalhes)</option>
                <option value="summary">üìù Resumir (mais conciso)</option>
                <option value="rewrite">‚úèÔ∏è Reescrever (criativo)</option>
            </select>
            <button @click="processFile" :disabled="!csvContent || processing" 
                    class="w-full mt-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg">
                <span x-show="!processing">üöÄ Processar com IA</span>
                <span x-show="processing">‚è≥ Processando...</span>
            </button>
        </div>

        <!-- Download Section -->
        <div x-show="result" class="space-y-4 mb-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-green-800 mb-4">‚úÖ Processamento Conclu√≠do</h3>
                
                <!-- Excel CSV Brasileiro -->
                <div class="bg-green-100 border border-green-300 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-green-900 mb-2">üìä Excel CSV Brasileiro (Ponto e V√≠rgula)</h4>
                    <button @click="downloadExcelCSV" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                        üì• Baixar para Excel (UTF-8 + Ponto e V√≠rgula)
                    </button>
                </div>

                <!-- CSV Padr√£o -->
                <div class="bg-blue-100 border border-blue-300 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-2">üìã CSV Padr√£o (V√≠rgula)</h4>
                    <button @click="downloadStandardCSV" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        üì• Baixar CSV Padr√£o (UTF-8)
                    </button>
                </div>
            </div>

            <!-- Preview -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <h4 class="font-semibold text-purple-900 mb-3">üëÅÔ∏è Pr√©via:</h4>
                <div class="bg-white rounded border overflow-x-auto">
                    <template x-for="(line, index) in getPreviewLines()" :key="index">
                        <div class="px-3 py-2 border-b font-mono text-xs" x-text="line.substring(0, 150)"></div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
        function csvProcessor() {
            return {
                csvContent: '',
                fileName: '',
                operation: 'expand',
                result: '',
                processing: false,

                async handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.fileName = file.name;
                    try {
                        this.csvContent = await this.readFileAsText(file);
                    } catch (error) {
                        alert('Erro ao carregar arquivo: ' + error.message);
                    }
                },

                async readFileAsText(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                let content = e.target.result;
                                content = this.cleanEncodingIssues(content);
                                resolve(content);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                        reader.readAsText(file, 'utf-8');
                    });
                },

                cleanEncodingIssues(text) {
                    if (text.charCodeAt(0) === 0xFEFF) {
                        text = text.slice(1);
                    }
                    
                    return text
                        .replace(/ÔøΩ/g, '')
                        .replace(/PK[^\w\s,;.\-_]+/g, '')
                        .replace(/√É¬°/g, '√°').replace(/√É¬©/g, '√©').replace(/√É¬≠/g, '√≠')
                        .replace(/√É¬≥/g, '√≥').replace(/√É¬∫/g, '√∫').replace(/√É¬ß/g, '√ß')
                        .replace(/√É¬±/g, '√±').replace(/√É /g, '√†').replace(/√É¬™/g, '√™')
                        .replace(/√É¬¥/g, '√¥').replace(/√É¬¢/g, '√¢').replace(/√É¬£/g, '√£')
                        .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '')
                        .replace(/[ \t]+/g, ' ')
                        .trim();
                },

                async processFile() {
                    if (!this.csvContent) return;
                    this.processing = true;
                    try {
                        const response = await fetch('/api/process', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                csvContent: this.csvContent,
                                operation: this.operation
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.result = data.result;
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        alert('Erro: ' + error.message);
                    } finally {
                        this.processing = false;
                    }
                },

                downloadExcelCSV() {
                    if (!this.result) return;
                    const excelContent = this.result
                        .split('\n')
                        .map(line => {
                            const fields = this.parseCSVLine(line);
                            return fields.map(field => {
                                if (field.includes(';') || field.includes('"')) {
                                    return `"${field.replace(/"/g, '""')}"`;
                                }
                                return field;
                            }).join(';');
                        })
                        .join('\n');
                    
                    const bom = '\uFEFF';
                    const blob = new Blob([bom + excelContent], { type: 'text/csv;charset=utf-8;' });
                    const filename = `processed_${this.operation}_excel_${Date.now()}.csv`;
                    this.downloadBlob(blob, filename);
                },

                downloadStandardCSV() {
                    if (!this.result) return;
                    const bom = '\uFEFF';
                    const blob = new Blob([bom + this.result], { type: 'text/csv;charset=utf-8;' });
                    const filename = `processed_${this.operation}_${Date.now()}.csv`;
                    this.downloadBlob(blob, filename);
                },

                parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    return result;
                },

                downloadBlob(blob, filename) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                },

                getPreviewLines() {
                    if (!this.result) return [];
                    return this.result.split('\n').slice(0, 5);
                }
            }
        }
    </script>
</body>
</html>
